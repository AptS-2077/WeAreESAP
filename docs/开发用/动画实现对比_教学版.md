# è·¯ç”±è¿‡æ¸¡åŠ¨ç”»å®ç°å¯¹æ¯” - æ•™å­¦ç‰ˆ

## ğŸ”´ æ–¹æ¡ˆä¸€ï¼šç›‘å¬ pathname è‡ªåŠ¨ç»“æŸï¼ˆä¹‹å‰çš„å®ç° - æœ‰é—®é¢˜ï¼‰

### æ ¸å¿ƒæ€è·¯
```
ç‚¹å‡»é“¾æ¥ â†’ å¼€å§‹åŠ¨ç”» â†’ è·¯ç”±è·³è½¬ â†’ pathname å˜åŒ– â†’ ç›‘å¬åˆ°å˜åŒ– â†’ ç­‰ 500ms â†’ ç»“æŸåŠ¨ç”»
```

### ä»£ç å®ç°

#### 1. TransitionContext.tsx - è¿‡æ¸¡ç®¡ç†å™¨
```tsx
export function TransitionProvider({ children }) {
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [transitionStartTime, setTransitionStartTime] = useState(null);
  const pathname = usePathname();  // å½“å‰è·¯ç”±è·¯å¾„

  // ğŸ‘‡ å…³é”®ä»£ç ï¼šç›‘å¬ pathname å˜åŒ–
  useEffect(() => {
    if (isTransitioning && transitionStartTime) {
      const elapsed = Date.now() - transitionStartTime;
      const remainingTime = Math.max(0, 500 - elapsed);  // è‡³å°‘ 500ms

      const timer = setTimeout(() => {
        setIsTransitioning(false);  // â† 500ms åå…³é—­åŠ¨ç”»
      }, remainingTime);

      return () => clearTimeout(timer);
    }
  }, [pathname, isTransitioning, transitionStartTime]);
  //   â†‘ pathname ä½œä¸ºä¾èµ–é¡¹
  //   pathname å˜åŒ–æ—¶ï¼Œè¿™ä¸ª useEffect ä¼šé‡æ–°æ‰§è¡Œ

  const startTransition = () => {
    setIsTransitioning(true);
    setTransitionStartTime(Date.now());
  };

  return (
    <TransitionContext.Provider value={{ isTransitioning, startTransition }}>
      {children}
    </TransitionContext.Provider>
  );
}
```

#### 2. TransitionLink.tsx - è·¯ç”±é“¾æ¥
```tsx
export function TransitionLink({ href, children }) {
  const router = useRouter();
  const { startTransition } = useTransition();

  const handleClick = (e) => {
    e.preventDefault();

    startTransition();      // â† æ­¥éª¤1: å¼€å§‹åŠ¨ç”»
    router.push(href);      // â† æ­¥éª¤2: ç«‹å³è·³è½¬è·¯ç”±
  };

  return <Link href={href} onClick={handleClick}>{children}</Link>;
}
```

#### 3. TransitionOverlay.tsx - åŠ è½½åŠ¨ç”»é®ç½©
```tsx
export function TransitionOverlay() {
  const { isTransitioning } = useTransition();

  return (
    <AnimatePresence>
      {isTransitioning && (  // â† isTransitioning = true æ—¶æ˜¾ç¤º
        <motion.div className="loading-overlay">
          <LoadingSpinner />  {/* æ—‹è½¬çš„ä¸‰è§’å½¢ LOGO */}
        </motion.div>
      )}
    </AnimatePresence>
  );
}
```

### æ‰§è¡Œæµç¨‹ï¼ˆæ—¶é—´çº¿ï¼‰

```
ç”¨æˆ·ç‚¹å‡» "è§’è‰²é¡µé¢" é“¾æ¥

t=0ms:
  â†“ handleClick æ‰§è¡Œ
  â†“ startTransition() â†’ isTransitioning = true
  â†“ TransitionOverlay æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
  â†“ router.push('/characters')

t=1ms:  (å‡ ä¹ç¬é—´)
  â†“ pathname ä» '/project' å˜æˆ '/characters'
  â†“ useEffect ç›‘å¬åˆ° pathname å˜åŒ–
  â†“ è®¾ç½®å®šæ—¶å™¨ï¼š500ms åå…³é—­åŠ¨ç”»

t=2ms ~ t=500ms:
  â†’ æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆæ—‹è½¬çš„ LOGOï¼‰
  â†’ æµè§ˆå™¨å¼€å§‹åŠ è½½æ–°é¡µé¢ç»„ä»¶
  â†’ é¡µé¢å†…å®¹å¯èƒ½è¿˜åœ¨æ¸²æŸ“...
  â†’ å›¾ç‰‡å¯èƒ½è¿˜åœ¨åŠ è½½...

t=500ms:
  â†“ å®šæ—¶å™¨è§¦å‘
  â†“ setIsTransitioning(false)
  â†“ åŠ è½½åŠ¨ç”»æ¶ˆå¤± âŒ ä½†é¡µé¢å¯èƒ½è¿˜æ²¡æ¸²æŸ“å®Œï¼

t=500ms ~ t=1000ms:
  â†’ ç”¨æˆ·å¯èƒ½çœ‹åˆ°ç™½å±
  â†’ æˆ–è€…çœ‹åˆ°å†…å®¹çªç„¶é—ªç°
  â†’ ä½“éªŒä¸æµç•… âŒ
```

### âŒ é—®é¢˜åœ¨å“ªï¼Ÿ

```tsx
useEffect(() => {
  // åªè¦ pathname å˜äº†ï¼Œå°±ä¼šåœ¨ 500ms åå…³é—­åŠ¨ç”»
  // ä½† pathname å˜åŒ– â‰  é¡µé¢æ¸²æŸ“å®Œæˆï¼
}, [pathname]);  // â† é—®é¢˜æ ¹æº
```

**pathname å˜åŒ–çš„æ—¶æœºï¼š** è·¯ç”±è·³è½¬åç«‹å³å˜åŒ–ï¼ˆ1-5msï¼‰
**é¡µé¢çœŸæ­£æ¸²æŸ“å®Œçš„æ—¶æœºï¼š** éœ€è¦åŠ è½½æ•°æ®ã€æ¸²æŸ“ç»„ä»¶ã€åŠ è½½å›¾ç‰‡ï¼ˆ500-2000msï¼‰

**æ—¶é—´å·®å¯¼è‡´é—®é¢˜ï¼š** åŠ¨ç”»åœ¨é¡µé¢è¿˜æ²¡å‡†å¤‡å¥½æ—¶å°±ç»“æŸäº†ã€‚

---

## ğŸŸ¢ æ–¹æ¡ˆäºŒï¼šç›‘å¬åŠ¨ç”»å®Œæˆå›è°ƒï¼ˆç°åœ¨çš„å®ç° - æ­£ç¡®ï¼‰

### æ ¸å¿ƒæ€è·¯
```
ç‚¹å‡»é“¾æ¥ â†’ å¼€å§‹åŠ¨ç”» â†’ è·¯ç”±è·³è½¬ â†’ æ–°é¡µé¢æ¸²æŸ“ â†’ è¿›å…¥åŠ¨ç”»æ’­æ”¾ â†’ åŠ¨ç”»å®Œæˆå›è°ƒ â†’ ç»“æŸåŠ è½½åŠ¨ç”»
```

### ä»£ç å®ç°

#### 1. TransitionContext.tsx - è¿‡æ¸¡ç®¡ç†å™¨ï¼ˆä¿®æ”¹åï¼‰
```tsx
export function TransitionProvider({ children }) {
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [transitionStartTime, setTransitionStartTime] = useState(null);
  // const pathname = usePathname();  â† ä¸å†éœ€è¦ç›‘å¬ pathname

  // âŒ åˆ é™¤äº†è¿™æ®µä»£ç ï¼š
  // useEffect(() => {
  //   if (pathname å˜åŒ–) {
  //     500ms åå…³é—­åŠ¨ç”»
  //   }
  // }, [pathname]);

  const startTransition = () => {
    // é˜²æ­¢é‡å¤ç‚¹å‡»
    if (isTransitioning) return;  // â† æ–°å¢ä¿æŠ¤

    setIsTransitioning(true);
    setTransitionStartTime(Date.now());
  };

  const finishTransition = () => {
    if (!transitionStartTime) return;

    const elapsed = Date.now() - transitionStartTime;
    const remainingTime = Math.max(0, 500 - elapsed);  // è‡³å°‘ 500ms

    setTimeout(() => {
      setIsTransitioning(false);  // â† ç¡®ä¿è‡³å°‘æ˜¾ç¤º 500ms
    }, remainingTime);
  };

  return (
    <TransitionContext.Provider
      value={{
        isTransitioning,
        startTransition,
        finishTransition  // â† æš´éœ²ç»™å¤–éƒ¨ä¸»åŠ¨è°ƒç”¨
      }}
    >
      {children}
    </TransitionContext.Provider>
  );
}
```

#### 2. PageTransition.tsx - é¡µé¢è¿‡æ¸¡ç»„ä»¶ï¼ˆä¿®æ”¹åï¼‰
```tsx
export function PageTransition({ children }) {
  const pathname = usePathname();
  const { finishTransition } = useTransition();  // â† è·å–ç»“æŸå‡½æ•°

  return (
    <motion.div
      key={pathname}  // â† pathname å˜åŒ–æ—¶ï¼Œè¿™ä¸ªç»„ä»¶ä¼šé‡æ–°æŒ‚è½½

      // è¿›å…¥åŠ¨ç”»é…ç½®
      initial={{ opacity: 0, y: 20 }}   // åˆå§‹ï¼šé€æ˜ + ä¸‹ç§» 20px
      animate={{ opacity: 1, y: 0 }}     // åŠ¨ç”»åˆ°ï¼šä¸é€æ˜ + å½’ä½

      transition={{ duration: 0.4 }}    // åŠ¨ç”»æŒç»­ 400ms

      // ğŸ‘‡ å…³é”®ï¼šåŠ¨ç”»å®Œæˆåçš„å›è°ƒ
      onAnimationComplete={() => {
        // é¡µé¢è¿›å…¥åŠ¨ç”»æ’­æ”¾å®Œæˆåï¼Œé€šçŸ¥ä¸Šä¸‹æ–‡ç»“æŸå…¨å±€è¿‡æ¸¡
        finishTransition();
      }}
    >
      {children}
    </motion.div>
  );
}
```

#### 3. TransitionLink.tsx - è·¯ç”±é“¾æ¥ï¼ˆä¼˜åŒ–åï¼‰
```tsx
export function TransitionLink({ href, children, className }) {
  const router = useRouter();
  const { startTransition, isTransitioning } = useTransition();

  const handleClick = (e) => {
    e.preventDefault();

    startTransition();  // å¦‚æœå·²åœ¨è¿‡æ¸¡ä¸­ï¼Œä¼šè¢«å¿½ç•¥
    router.push(href);
  };

  return (
    <Link
      href={href}
      onClick={handleClick}
      className={`
        ${className}
        ${isTransitioning ? 'pointer-events-none opacity-60' : ''}
      `}
      // â†‘ è¿‡æ¸¡ä¸­ç¦ç”¨ç‚¹å‡» + åŠé€æ˜æç¤º
    >
      {children}
    </Link>
  );
}
```

### æ‰§è¡Œæµç¨‹ï¼ˆæ—¶é—´çº¿ï¼‰

```
ç”¨æˆ·ç‚¹å‡» "è§’è‰²é¡µé¢" é“¾æ¥

t=0ms:
  â†“ handleClick æ‰§è¡Œ
  â†“ startTransition() â†’ isTransitioning = true
  â†“ TransitionOverlay æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
  â†“ router.push('/characters')

t=1ms:
  â†“ pathname å˜åŒ–
  â†“ PageTransition ç»„ä»¶æ£€æµ‹åˆ° key={pathname} å˜åŒ–
  â†“ æ—§çš„ PageTransition å¸è½½
  â†“ æ–°çš„ PageTransition æŒ‚è½½ï¼Œåˆå§‹çŠ¶æ€ opacity=0, y=20

t=50ms ~ t=300ms:
  â†’ æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆæ—‹è½¬çš„ LOGOï¼‰
  â†’ Next.js åŠ è½½æ–°é¡µé¢ç»„ä»¶
  â†’ CharactersClient ç»„ä»¶æ¸²æŸ“
  â†’ å›¾ç‰‡å¼€å§‹åŠ è½½

t=300ms:
  âœ… æ–°é¡µé¢å†…å®¹æ¸²æŸ“å®Œæˆ
  âœ… PageTransition å¼€å§‹æ’­æ”¾è¿›å…¥åŠ¨ç”»
  â†’ opacity: 0 â†’ 1 (0.4s)
  â†’ y: 20 â†’ 0 (0.4s)

t=700ms: (300ms + 400ms åŠ¨ç”»)
  âœ… è¿›å…¥åŠ¨ç”»æ’­æ”¾å®Œæˆ
  âœ… onAnimationComplete å›è°ƒè§¦å‘
  â†“ è°ƒç”¨ finishTransition()
  â†“ è®¡ç®—ç»è¿‡æ—¶é—´: 700ms - 0ms = 700ms
  â†“ å‰©ä½™æ—¶é—´: max(0, 500 - 700) = 0ms
  â†“ ç«‹å³å…³é—­åŠ è½½åŠ¨ç”» (å› ä¸ºå·²ç»è¶…è¿‡ 500ms)

t=700ms:
  âœ… isTransitioning = false
  âœ… TransitionOverlay æ¶ˆå¤±
  âœ… ç”¨æˆ·çœ‹åˆ°å®Œæ•´æ¸²æŸ“çš„é¡µé¢
  âœ… è¿‡æ¸¡æµç•…ï¼
```

### âœ… ä¸ºä»€ä¹ˆè¿™æ ·å°±å¯¹äº†ï¼Ÿ

#### å…³é”®1: `key={pathname}` çš„ä½œç”¨
```tsx
<motion.div key={pathname}>
  {children}
</motion.div>
```

åœ¨ React ä¸­ï¼Œ`key` æ”¹å˜æ—¶ï¼Œç»„ä»¶ä¼š**å®Œå…¨é‡æ–°æŒ‚è½½**ï¼š
- pathname = '/project' â†’ ç»„ä»¶ A æŒ‚è½½
- pathname = '/characters' â†’ ç»„ä»¶ A å¸è½½ï¼Œç»„ä»¶ B æŒ‚è½½
- ç»„ä»¶ B æŒ‚è½½æ—¶ä¼šä» `initial` çŠ¶æ€å¼€å§‹æ’­æ”¾åŠ¨ç”»

#### å…³é”®2: `onAnimationComplete` çš„æ—¶æœº
```tsx
onAnimationComplete={() => {
  finishTransition();  // â† è¿™æ—¶æ–°é¡µé¢å·²ç»æ¸²æŸ“å¥½äº†
}}
```

è¿™ä¸ªå›è°ƒè§¦å‘æ—¶ï¼Œæ„å‘³ç€ï¼š
1. âœ… æ–°é¡µé¢ç»„ä»¶å·²ç»æŒ‚è½½
2. âœ… æ–°é¡µé¢å†…å®¹å·²ç»æ¸²æŸ“
3. âœ… è¿›å…¥åŠ¨ç”»å·²ç»æ’­æ”¾å®Œæˆ
4. âœ… ç”¨æˆ·å·²ç»èƒ½çœ‹åˆ°å®Œæ•´é¡µé¢

**æ‰€ä»¥è¿™æ—¶å…³é—­åŠ è½½åŠ¨ç”»æ˜¯å®‰å…¨çš„ï¼**

#### å…³é”®3: `finishTransition()` çš„ä¿æŠ¤æœºåˆ¶
```tsx
const finishTransition = () => {
  const elapsed = Date.now() - transitionStartTime;
  const remainingTime = Math.max(0, 500 - elapsed);

  setTimeout(() => {
    setIsTransitioning(false);
  }, remainingTime);
};
```

è¿™æ®µä»£ç ç¡®ä¿ï¼š
- å¦‚æœåŠ¨ç”»æ’­æ”¾å¤ªå¿«ï¼ˆæ¯”å¦‚ 200msï¼‰ï¼Œä¼šç­‰åˆ° 500ms å†å…³é—­
- å¦‚æœåŠ¨ç”»å·²ç»å¾ˆé•¿ï¼ˆæ¯”å¦‚ 700msï¼‰ï¼Œç«‹å³å…³é—­
- **é¿å…åŠ¨ç”»é—ªç°ï¼Œåˆä¸ä¼šç­‰å¤ªä¹…**

---

## ğŸ“Š ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”è¡¨

| å¯¹æ¯”é¡¹ | æ–¹æ¡ˆä¸€ï¼ˆç›‘å¬ pathnameï¼‰ | æ–¹æ¡ˆäºŒï¼ˆç›‘å¬åŠ¨ç”»å®Œæˆï¼‰ |
|--------|------------------------|----------------------|
| **è§¦å‘æ—¶æœº** | pathname å˜åŒ–å 500ms | é¡µé¢åŠ¨ç”»å®Œæˆå |
| **æ˜¯å¦ç­‰å¾…æ¸²æŸ“** | âŒ ä¸ç­‰å¾… | âœ… ç­‰å¾… |
| **ç”¨æˆ·ä½“éªŒ** | å¯èƒ½çœ‹åˆ°ç™½å±/é—ªç° | æµç•…è¿‡æ¸¡ |
| **ä»£ç å¤æ‚åº¦** | ç®€å• | ç¨å¤æ‚ï¼ˆéœ€è¦ç†è§£ Framer Motionï¼‰ |
| **é€‚ç”¨åœºæ™¯** | é¡µé¢å¾ˆç®€å•ï¼ŒåŠ è½½å¾ˆå¿« | æ‰€æœ‰åœºæ™¯ |
| **å¯é æ€§** | ä¸å¯é ï¼ˆä¾èµ–å›ºå®šæ—¶é•¿ï¼‰ | å¯é ï¼ˆå®é™…ç›‘å¬å®Œæˆï¼‰ |

---

## ğŸ¯ å…³é”®çŸ¥è¯†ç‚¹æ€»ç»“

### 1. React çš„ useEffect ä¾èµ–æ•°ç»„
```tsx
useEffect(() => {
  // è¿™é‡Œçš„ä»£ç ä¼šåœ¨ä¾èµ–é¡¹å˜åŒ–æ—¶æ‰§è¡Œ
}, [dependency]);  // â† ä¾èµ–é¡¹åˆ—è¡¨
```

### 2. Framer Motion çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ
```tsx
<motion.div
  onAnimationStart={() => {}}      // åŠ¨ç”»å¼€å§‹
  onAnimationComplete={() => {}}   // åŠ¨ç”»å®Œæˆ â† æˆ‘ä»¬ç”¨è¿™ä¸ª
  onAnimationUpdate={() => {}}     // åŠ¨ç”»æ¯ä¸€å¸§
/>
```

### 3. React çš„ key å±æ€§
```tsx
<Component key={value} />
```
- `key` å˜åŒ– â†’ ç»„ä»¶å¸è½½å¹¶é‡æ–°æŒ‚è½½
- åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥é‡ç½®åŠ¨ç”»çŠ¶æ€

### 4. çŠ¶æ€ç®¡ç†çš„ä¿æŠ¤æœºåˆ¶
```tsx
if (isTransitioning) return;  // é˜²æ­¢é‡å¤è§¦å‘
```

### 5. æ—¶é—´è®¡ç®—çš„æŠ€å·§
```tsx
const elapsed = Date.now() - startTime;
const remaining = Math.max(0, minTime - elapsed);
```
ç¡®ä¿æœ€å°æ—¶é•¿ï¼ŒåŒæ—¶ä¸ä¼šç­‰å¤ªä¹…ã€‚

---

## ğŸ’¡ å®æˆ˜å»ºè®®

å¦‚æœä½ ä»¥åè¦å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼š

1. **ä¼˜å…ˆç›‘å¬å®é™…äº‹ä»¶**ï¼ˆå¦‚åŠ¨ç”»å®Œæˆï¼‰ï¼Œè€Œä¸æ˜¯å‡è®¾æ—¶é—´
2. **æ·»åŠ ä¿æŠ¤æœºåˆ¶**ï¼ˆæœ€å°/æœ€å¤§æ—¶é•¿ã€é˜²é‡å¤ï¼‰
3. **ç”¨å›è°ƒè€Œä¸æ˜¯è½®è¯¢**ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
4. **å…³é”®æ“ä½œåŠ æ³¨é‡Š**ï¼Œæ–¹ä¾¿ä»¥åç»´æŠ¤

å¸Œæœ›è¿™ä¸ªæ•™å­¦ç‰ˆå¯¹ä½ æœ‰å¸®åŠ©ï¼æœ‰ä¸æ‡‚çš„åœ°æ–¹éšæ—¶é—®æˆ‘ ğŸ¤
